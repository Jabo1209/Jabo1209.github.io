<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Lab Meeting</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --cell-height: 75px; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1150px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .button-group { display: flex; gap: 8px; align-items: center; }
        
        button { padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; border: 1px solid #ccc; }
        .btn-img { background: #27ae60; color: white; border: none; }
        .btn-save { background: #34495e; color: white; border: none; }
        .btn-edit { background: #e67e22; color: white; border: none; }
        
        /* å­¸ç”Ÿé¸æ“‡å€ */
        .student-selector { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; padding: 12px; background: #eef2f3; border-radius: 8px; border: 1px dashed #ccc; }
        .stu-btn { border: 2px solid #ccc; background: white; border-radius: 20px; padding: 6px 15px; cursor: pointer; position: relative; }
        .stu-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        .del-stu { color: #ff4757; margin-left: 8px; font-size: 14px; cursor: pointer; }

        /* ç·¨è¼¯åå–®å½ˆçª—æ¨£å¼ */
        #editSection { display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeeba; text-align: center; }
        #newStuName { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 150px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #ddd; text-align: center; vertical-align: top; padding: 5px; }
        th { background: #f8f9fa; height: 40px; }
        .time-col { background: #f8f9fa; font-weight: bold; font-size: 0.85em; width: 90px; height: var(--cell-height); }
        
        .slot { cursor: pointer; transition: background 0.1s; }
        .name-tag { display: inline-block; background: #e1f5fe; color: #01579b; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 0.8em; border: 1px solid #b3e5fc; }
        .hide-names .name-tag { display: none; }

        .level-1 { background-color: #fff5f5 !important; }
        .level-max { background-color: #ffa8a8 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h2>ğŸ”¬ Lab Meeting</h2>
        <div class="button-group">
            <label style="font-size: 0.9em; font-weight: bold;">
                <input type="checkbox" id="showNameToggle" checked onchange="toggleNameDisplay()"> é¡¯ç¤ºå§“å
            </label>
            <button class="btn-edit" onclick="toggleEditMode()">âœï¸ ç·¨è¼¯åå–®</button>
            <button class="btn-img" onclick="exportImage()">ğŸ“¸ ä¸‹è¼‰åœ–ç‰‡</button>
            <button class="btn-save" onclick="saveToFile()">ğŸ’¾ åŒ¯å‡ºå‚™ä»½</button>
            <button class="btn-load" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadFromFile(event)">
        </div>
    </div>

    <div id="editSection">
        <input type="text" id="newStuName" placeholder="è¼¸å…¥å­¸ç”Ÿå§“å">
        <button onclick="addStudent()">â• æ–°å¢æˆå“¡</button>
        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">é»æ“Šä¸‹æ–¹åå­—æ—çš„ Ã— å³å¯åˆªé™¤æˆå“¡</div>
    </div>
    
    <div class="student-selector" id="studentSelector"></div>

    <div id="captureArea" style="background: white; padding: 5px;">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>æ™‚æ®µ</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // é è¨­åå–®
    let students = ["è©¹éˆçµ¡", "æ¥Šè‚²å˜‰", "è¨±é‹®æ˜±", "ç‹æŸäºº", "å¼µå®¶æ¦•", "èŠé›…ç­‘", "FAROOK"];
    let scheduleData = {};
    let currentStudent = students[0];
    let isEditMode = false;

    const sessions = Array.from({length: 13}, (_, i) => ({id: i+1, t: `${8+i}:10`}));

    function init() {
        renderStudentBtns();
        renderTable();
    }

    // æ¸²æŸ“å­¸ç”ŸæŒ‰éˆ•
    function renderStudentBtns() {
        const selector = document.getElementById('studentSelector');
        selector.innerHTML = '';
        students.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'stu-btn' + (name === currentStudent ? ' active' : '');
            btn.innerHTML = name + (isEditMode ? `<span class="del-stu" onclick="removeStudent(event, '${name}')">Ã—</span>` : '');
            
            if (!isEditMode) {
                btn.onclick = () => {
                    document.querySelectorAll('.stu-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStudent = name;
                };
            }
            selector.appendChild(btn);
        });
    }

    // ç·¨è¼¯æ¨¡å¼åˆ‡æ›
    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('editSection').style.display = isEditMode ? 'block' : 'none';
        renderStudentBtns();
    }

    // æ–°å¢å­¸ç”Ÿ
    function addStudent() {
        const name = document.getElementById('newStuName').value.trim();
        if (name && !students.includes(name)) {
            students.push(name);
            document.getElementById('newStuName').value = '';
            renderStudentBtns();
        }
    }

    // åˆªé™¤å­¸ç”Ÿ (åŒ…å«æ¸…ç†èª²è¡¨æ•¸æ“š)
    function removeStudent(event, name) {
        event.stopPropagation();
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${name} å—ï¼Ÿç›¸é—œèª²è¡¨ç´€éŒ„ä¹Ÿæœƒä¸€ä½µæ¸…é™¤ã€‚`)) {
            students = students.filter(s => s !== name);
            // æ¸…ç†æ•¸æ“šä¸­è©²å­¸ç”Ÿçš„åå­—
            for (let key in scheduleData) {
                scheduleData[key] = scheduleData[key].filter(s => s !== name);
            }
            if (currentStudent === name) currentStudent = students[0] || "";
            renderStudentBtns();
            renderTable();
        }
    }

    function toggleNameDisplay() {
        const table = document.getElementById('mainTable');
        document.getElementById('showNameToggle').checked ? table.classList.remove('hide-names') : table.classList.add('hide-names');
    }

    function toggleSlot(day, sid) {
        if (isEditMode || !currentStudent) return;
        const key = `${day}-${sid}`;
        if (!scheduleData[key]) scheduleData[key] = [];
        const idx = scheduleData[key].indexOf(currentStudent);
        if (idx > -1) scheduleData[key].splice(idx, 1);
        else scheduleData[key].push(currentStudent);
        renderTable();
    }

    function renderTable() {
        const body = document.getElementById('timetableBody');
        body.innerHTML = '';
        sessions.forEach(s => {
            let row = `<tr><td class="time-col">ç¬¬ ${s.id} ç¯€</td>`;
            for (let d = 1; d <= 5; d++) {
                const list = scheduleData[`${d}-${s.id}`] || [];
                let c = list.length >= 4 ? 'level-max' : (list.length >= 1 ? 'level-1' : '');
                const tags = list.map(n => `<span class="name-tag">${n}</span>`).join('');
                row += `<td class="slot ${c}" onclick="toggleSlot(${d}, ${s.id})">${tags}</td>`;
            }
            row += `</tr>`;
            body.innerHTML += row;
        });
    }

    function saveToFile() {
        const fullData = { students, scheduleData }; // æŠŠåå–®è·Ÿèª²è¡¨åŒ…åœ¨ä¸€èµ·å­˜
        const blob = new Blob([JSON.stringify(fullData, null, 2)], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "lab_meeting_full_backup.json";
        link.click();
    }

    function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°ç‰ˆæ ¼å¼ (åŒ…å« students æ¬„ä½)
            if (imported.students && imported.scheduleData) {
                students = imported.students;
                scheduleData = imported.scheduleData;
            } else {
                // å¦‚æœæ˜¯èˆŠç‰ˆæ ¼å¼ï¼Œç›´æ¥æŠŠæ•´å€‹ç‰©ä»¶ç•¶æˆèª²è¡¨æ•¸æ“š
                // ä¸¦ä¿ç•™ç›®å‰çš„é è¨­åå–®
                scheduleData = imported;
                alert("åµæ¸¬åˆ°èˆŠç‰ˆæ•¸æ“šï¼Œå·²æˆåŠŸåŒ¯å…¥èª²è¡¨ï¼");
            }
            
            currentStudent = students[0] || "";
            init(); // é‡æ–°åˆå§‹åŒ–ä»‹é¢
        } catch (err) {
            alert("è®€å–å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–æª”æ¡ˆå·²æå£");
            console.error(err);
        }
        event.target.value = ''; 
    };
    reader.readAsText(file);
    }

    function exportImage() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Schedule.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    window.onload = init;
</script>
</body>
</html>