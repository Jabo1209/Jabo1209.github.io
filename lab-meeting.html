<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Lab Meeting æ’ç­ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --cell-height: 75px; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1150px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .button-group { display: flex; gap: 8px; align-items: center; }
        button { padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; border: 1px solid #ccc; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-img { background: #27ae60; color: white; border: none; }
        .btn-save { background: #34495e; color: white; border: none; }
        .btn-edit { background: #e67e22; color: white; border: none; }
        .student-selector { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; padding: 12px; background: #eef2f3; border-radius: 8px; border: 1px dashed #ccc; min-height: 50px; }
        .stu-btn { border: 2px solid #ccc; background: white; border-radius: 20px; padding: 6px 15px; cursor: pointer; }
        .stu-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        .del-stu { color: #ff4757; margin-left: 8px; font-weight: bold; }
        #editSection { display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeeba; text-align: center; }
        #newStuName { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 150px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #ddd; text-align: center; vertical-align: top; padding: 5px; }
        th { background: #f8f9fa; height: 40px; }
        .time-col { background: #f8f9fa; font-weight: bold; font-size: 0.85em; width: 90px; height: var(--cell-height); }
        .slot { cursor: pointer; }
        .name-tag { display: inline-block; background: #e1f5fe; color: #01579b; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 0.8em; border: 1px solid #b3e5fc; }
        .hide-names .name-tag { display: none; }
        .level-1 { background-color: #fff5f5 !important; }
        .level-max { background-color: #ffa8a8 !important; }
        .empty-hint { color: #888; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h2>ğŸ”¬ Lab Meeting æ’ç­ç³»çµ±</h2>
        <div class="button-group">
            <label style="font-size: 0.9em; font-weight: bold;">
                <input type="checkbox" id="showNameToggle" checked onchange="toggleNameDisplay()"> é¡¯ç¤ºå§“å
            </label>
            <button class="btn-edit" onclick="toggleEditMode()">âœï¸ ç·¨è¼¯åå–®</button>
            <button class="btn-img" onclick="exportImage()">ğŸ“¸ ä¸‹è¼‰åœ–ç‰‡</button>
            <button class="btn-save" onclick="saveToFile()">ğŸ’¾ åŒ¯å‡ºå‚™ä»½</button>
            <button class="btn-load" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadFromFile(event)">
        </div>
    </div>

    <div id="editSection">
        <input type="text" id="newStuName" placeholder="è¼¸å…¥å­¸ç”Ÿå§“å" onkeypress="if(event.keyCode==13) addStudent()">
        <button onclick="addStudent()">â• æ–°å¢æˆå“¡</button>
    </div>
    
    <div class="student-selector" id="studentSelector">
        <span class="empty-hint">ç›®å‰ç„¡æˆå“¡ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯åå–®ã€æ–°å¢æˆ–ã€ŒåŒ¯å…¥å‚™ä»½ã€è®€å–æª”æ¡ˆ</span>
    </div>

    <div id="captureArea" style="background: white; padding: 5px;">
        <table id="mainTable">
            <thead>
                <tr><th>æ™‚æ®µ</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th></tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let students = []; 
    let scheduleData = {};
    let currentStudent = "";
    let isEditMode = false;

    const sessions = Array.from({length: 13}, (_, i) => ({id: i+1}));

    function init() {
        renderStudentBtns();
        renderTable();
    }

    function renderStudentBtns() {
        const selector = document.getElementById('studentSelector');
        if (students.length === 0) {
            selector.innerHTML = '<span class="empty-hint">ç›®å‰ç„¡æˆå“¡ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯åå–®ã€æ–°å¢æˆ–ã€ŒåŒ¯å…¥å‚™ä»½ã€è®€å–æª”æ¡ˆ</span>';
            return;
        }
        
        selector.innerHTML = '';
        students.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'stu-btn' + (name === currentStudent ? ' active' : '');
            btn.innerHTML = name + (isEditMode ? `<span class="del-stu" onclick="removeStudent(event, '${name}')">Ã—</span>` : '');
            
            if (!isEditMode) {
                btn.onclick = () => {
                    document.querySelectorAll('.stu-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStudent = name;
                };
            }
            selector.appendChild(btn);
        });
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('editSection').style.display = isEditMode ? 'block' : 'none';
        renderStudentBtns();
    }

    function addStudent() {
        const nameInput = document.getElementById('newStuName');
        const name = nameInput.value.trim();
        if (name && !students.includes(name)) {
            students.push(name);
            if (!currentStudent) currentStudent = name;
            nameInput.value = '';
            renderStudentBtns();
        }
    }

    function removeStudent(event, name) {
        event.stopPropagation();
        if (confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿ`)) {
            students = students.filter(s => s !== name);
            for (let key in scheduleData) {
                scheduleData[key] = scheduleData[key].filter(s => s !== name);
            }
            if (currentStudent === name) currentStudent = students[0] || "";
            renderStudentBtns();
            renderTable();
        }
    }

    function toggleNameDisplay() {
        const table = document.getElementById('mainTable');
        document.getElementById('showNameToggle').checked ? table.classList.remove('hide-names') : table.classList.add('hide-names');
    }

    function toggleSlot(day, sid) {
        if (isEditMode || !currentStudent) return;
        const key = `${day}-${sid}`;
        if (!scheduleData[key]) scheduleData[key] = [];
        const idx = scheduleData[key].indexOf(currentStudent);
        if (idx > -1) scheduleData[key].splice(idx, 1);
        else scheduleData[key].push(currentStudent);
        renderTable();
    }

    function renderTable() {
        const body = document.getElementById('timetableBody');
        body.innerHTML = '';
        sessions.forEach(s => {
            let row = `<tr><td class="time-col">ç¬¬ ${s.id} ç¯€</td>`;
            for (let d = 1; d <= 5; d++) {
                const list = scheduleData[`${d}-${s.id}`] || [];
                let c = list.length >= 4 ? 'level-max' : (list.length >= 1 ? 'level-1' : '');
                const tags = list.map(n => `<span class="name-tag">${n}</span>`).join('');
                row += `<td class="slot ${c}" onclick="toggleSlot(${d}, ${s.id})">${tags}</td>`;
            }
            row += `</tr>`;
            body.innerHTML += row;
        });
    }

    function saveToFile() {
        if (students.length === 0) { alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥å‚™ä»½"); return; }
        const fullData = { students, scheduleData };
        const blob = new Blob([JSON.stringify(fullData, null, 2)], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "lab_meeting_data.json";
        link.click();
    }

    function loadFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                
                // æ ¸å¿ƒé‚è¼¯ï¼šå¾ JSON ä¸­æå–åå–®ä¸¦åŒæ­¥åˆ°æŒ‰éˆ•
                if (imported.students && Array.isArray(imported.students)) {
                    students = imported.students; // ç›´æ¥è¦†è“‹ç›®å‰åå–®
                    scheduleData = imported.scheduleData || {};
                } else {
                    // å¦‚æœè®€å–çš„æ˜¯èˆŠç‰ˆæ ¼å¼ï¼ˆåªæœ‰èª²è¡¨ï¼‰ï¼Œå‰‡å¾èª²è¡¨ä¸­æƒææ‰€æœ‰äººå
                    scheduleData = imported;
                    let extractedNames = new Set();
                    Object.values(scheduleData).forEach(arr => {
                        if (Array.isArray(arr)) arr.forEach(name => extractedNames.add(name));
                    });
                    students = Array.from(extractedNames);
                    alert("å·²å¾èª²è¡¨æ•¸æ“šä¸­æå–åå–®ï¼");
                }

                currentStudent = students[0] || ""; // è‡ªå‹•é¸å–ç¬¬ä¸€å€‹æˆå“¡
                renderStudentBtns(); // ç«‹å³é‡æ–°ç¹ªè£½äººåæŒ‰éˆ•
                renderTable(); // ç«‹å³é‡æ–°ç¹ªè£½è¡¨æ ¼å…§å®¹
                alert("å‚™ä»½è®€å–æˆåŠŸï¼Œåå–®å·²æ›´æ–°ï¼");
            } catch (err) { 
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª JSON æ ¼å¼ã€‚"); 
                console.error(err);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    function exportImage() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Schedule_Export.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    window.onload = init;
</script>
</body>
</html>